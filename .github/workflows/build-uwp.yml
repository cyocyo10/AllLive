name: Build UWP

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Decode certificate
        run: |
          $cert = [System.Convert]::FromBase64String("${{ secrets.SIGNING_CERTIFICATE }}")
          [IO.File]::WriteAllBytes("${{ github.workspace }}\AllLive.UWP\AllLive.UWP_TemporaryKey.pfx", $cert)

      - name: Update version number
        run: |
          $manifest = "${{ github.workspace }}\AllLive.UWP\Package.appxmanifest"
          $xml = [xml](Get-Content $manifest)
          $version = $xml.Package.Identity.Version -replace '\.\d+$', '.${{ github.run_number }}'
          $xml.Package.Identity.Version = $version
          $xml.Save($manifest)
          Write-Host "Version updated to: $version"

      - name: Restore NuGet packages
        run: nuget restore AllLive.sln

      - name: Build AllLive.Core
        run: msbuild AllLive.Core/AllLive.Core.csproj /p:Configuration=Release /p:Platform="Any CPU"

      - name: Build UWP
        run: |
          msbuild AllLive.UWP/AllLive.UWP.csproj /p:Configuration=Release /p:Platform=x64 /p:AppxBundlePlatforms="x64" /p:AppxBundle=Never /p:UapAppxPackageBuildMode=SideloadOnly /p:AppxPackageSigningEnabled=true /p:PackageCertificateKeyFile="AllLive.UWP_TemporaryKey.pfx"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AllLive-UWP-x64
          path: |
            AllLive.UWP/AppPackages/**/*.msix
            AllLive.UWP/AppPackages/**/*.cer
          compression-level: 9

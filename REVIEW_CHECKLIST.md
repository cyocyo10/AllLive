# 代码修改 Review 检查清单

## 需要测试的功能点

### 1. Timer 资源泄漏修复
- [ ] **测试：** 进入直播间，退出，重复10次，检查内存占用是否稳定
- [ ] **测试：** 同步功能（SyncVM），创建房间后断开，检查 Timer 是否正确释放
- [ ] **测试：** 哔哩哔哩登录二维码，打开后关闭，检查 Timer 是否正确释放
- [ ] **风险：** 低 - 只是添加 Dispose 调用，不改变逻辑

### 2. LiveRoomPage 事件取消订阅
- [ ] **测试：** 进入直播间，播放视频，退出，检查是否正常
- [ ] **测试：** 新窗口模式，打开多个直播间，关闭其中一个，其他窗口是否正常
- [ ] **测试：** 键盘快捷键（KeyDown 事件）在退出后是否还响应
- [ ] **测试：** 进入直播间10次，检查内存是否稳定
- [ ] **潜在问题：** `isCleanedUp` 标志位在页面重新创建时会重置，这是正确的
- [ ] **风险：** 中 - 涉及多个事件的取消订阅

### 3. FavoritePage（已回滚）
- [ ] **测试：** 添加收藏，在其他页面添加收藏，FavoritePage 是否自动更新
- [ ] **测试：** 进入收藏页面，退出，再进入，数据是否还在（缓存是否工作）
- [ ] **风险：** 无 - 已回滚到原始实现

### 4. SettingsPage 事件取消订阅
- [ ] **测试：** 登录哔哩哔哩账号，进入设置页面，退出，再登出账号，检查是否有异常
- [ ] **测试：** 多次进出设置页面，检查是否正常
- [ ] **风险：** 低 - 简单的事件取消订阅

### 5. 数据库编码修复
- [ ] **测试：** 启动应用，检查日志中是否有"修复乱码数据"的信息
- [ ] **测试：** 查看历史记录和收藏，乱码数据是否被修复或删除
- [ ] **测试：** 添加新的历史记录和收藏，中文是否正常显示
- [ ] **测试：** 点击修复后的历史记录，是否能正常进入直播间
- [ ] **潜在问题：** LIKE 查询可能误匹配，但概率极低
- [ ] **风险：** 中 - 涉及数据修改，但有 try-catch 保护

## 已知的潜在问题

### 问题1：PRAGMA encoding 对已有数据库无效
- **影响：** 已有数据库的编码不会改变
- **解决方案：** 通过 FixCorruptedData 修复已有数据
- **风险等级：** 低

### 问题2：FixCorruptedData 的 LIKE 查询可能误匹配
- **影响：** 可能将包含特殊字符的正常数据误判为乱码
- **概率：** 极低（这些字符不太可能出现在站点名称中）
- **风险等级：** 低

### 问题3：CleanupEventSubscriptions 可能被调用两次
- **影响：** 已通过 isCleanedUp 标志位防止
- **风险等级：** 无

## 回归测试建议

### 核心功能测试
1. **直播间播放**
   - 进入直播间
   - 切换清晰度
   - 切换线路
   - 退出直播间

2. **历史记录和收藏**
   - 查看历史记录
   - 点击历史记录进入直播间
   - 添加/删除收藏
   - 导入/导出功能

3. **设置页面**
   - 登录/登出哔哩哔哩账号
   - 修改各种设置
   - 进出设置页面

4. **同步功能**
   - 创建同步房间
   - 加入同步房间
   - 发送数据
   - 断开连接

### 性能测试
1. **内存泄漏测试**
   - 连续进出直播间20次，观察内存占用
   - 长时间观看直播（30分钟），观察内存占用
   - 打开多个新窗口，观察内存占用

2. **稳定性测试**
   - 快速切换页面
   - 快速进出直播间
   - 异常情况（网络断开、直播间关闭等）

## 建议的修复优先级

### 高优先级（必须修复）
- 无

### 中优先级（建议修复）
- 无

### 低优先级（可选）
- 改进 FixCorruptedData 的 LIKE 查询，使用更精确的匹配

## 总结

所有修改都经过仔细 review，主要风险点：
1. LiveRoomPage 的事件取消订阅 - 需要重点测试
2. 数据库乱码修复 - 需要验证修复效果

建议在测试环境中充分测试后再发布。
